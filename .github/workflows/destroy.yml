name: Purge AWS Environment

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to purge (dev/test/prod)"
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
      confirm:
        description: 'Type "PURGE" to confirm'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  PROJECT: stockwiz

jobs:
  purge:
    runs-on: ubuntu-latest

    steps:
    - name: Validate confirmation
      run: |
        if [ "${{ github.event.inputs.confirm }}" != "PURGE" ]; then
          echo "Purge cancelled."
          exit 1
        fi

    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure AWS credentials (REFRESH)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    #################################################################
    # DELETE ECS SERVICES
    #################################################################
    - name: Delete ECS Services
      run: |
        ENV="${{ github.event.inputs.env }}"
        CLUSTER="ecs-fargate-cluster-$ENV"
        echo "Deleting services in $CLUSTER"

        SERVICES=$(aws ecs list-services --cluster $CLUSTER --query "serviceArns[]" --output text || true)

        for SVC in $SERVICES; do
          echo "Deleting service: $SVC"
          aws ecs delete-service --cluster $CLUSTER --service $SVC --force || true
        done

    #################################################################
    # DELETE ECS CLUSTER
    #################################################################
    - name: Delete ECS Cluster
      run: |
        ENV="${{ github.event.inputs.env }}"
        CLUSTER="ecs-fargate-cluster-$ENV"

        echo "Deleting ECS Cluster: $CLUSTER"
        aws ecs delete-cluster --cluster $CLUSTER || true

    #################################################################
    # DELETE TARGET GROUPS
    #################################################################
    - name: Delete Target Groups
      run: |
        ENV="${{ github.event.inputs.env }}"
        TG_LIST=$(aws elbv2 describe-target-groups \
          --query "TargetGroups[?contains(TargetGroupName, '$ENV')].TargetGroupArn" \
          --output text || true)

        for TG in $TG_LIST; do
          echo "Deleting Target Group: $TG"
          aws elbv2 delete-target-group --target-group-arn $TG || true
        done

    #################################################################
    # DELETE LOAD BALANCERS
    #################################################################
    - name: Delete ALBs
      run: |
        ENV="${{ github.event.inputs.env }}"
        LBS=$(aws elbv2 describe-load-balancers \
          --query "LoadBalancers[?contains(LoadBalancerName, '$ENV')].LoadBalancerArn" \
          --output text || true)

        for LB in $LBS; do
          echo "Deleting ALB: $LB"
          aws elbv2 delete-load-balancer --load-balancer-arn $LB || true
        done

    #################################################################
    # DELETE ECR REPOSITORIES
    #################################################################
    - name: Delete ECR repositories
      run: |
        ENV="${{ github.event.inputs.env }}"
        PREFIX="${PROJECT}-${ENV}"

        echo "Deleting ECR repos with prefix: $PREFIX"

        REPOS=$(aws ecr describe-repositories \
          --query "repositories[?starts_with(repositoryName, '$PREFIX')].repositoryName" \
          --output text || true)

        for R in $REPOS; do
          echo "Deleting ECR repo: $R"
          aws ecr delete-repository --repository-name $R --force || true
        done

    #################################################################
    # DELETE VPC + SUBNETS + IGW + ROUTES (full cleanup)
    #################################################################
    - name: Delete VPC Resources
      run: |
        ENV="${{ github.event.inputs.env }}"
        VPC_ID=$(aws ec2 describe-vpcs \
          --filters "Name=tag:Name,Values=stockwiz-$ENV-vpc" \
          --query "Vpcs[0].VpcId" \
          --output text || true)

        if [ "$VPC_ID" == "None" ] || [ -z "$VPC_ID" ]; then
          echo "No VPC found"
          exit 0
        fi

        echo "Purging VPC $VPC_ID"

        # Delete subnets
        SUBNETS=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" \
          --query "Subnets[*].SubnetId" --output text)

        for S in $SUBNETS; do
          echo "Deleting Subnet: $S"
          aws ec2 delete-subnet --subnet-id $S || true
        done

        # Delete route tables
        RTB=$(aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$VPC_ID" \
          --query "RouteTables[*].RouteTableId" --output text)

        for R in $RTB; do
          echo "Deleting Route Table: $R"
          aws ec2 delete-route-table --route-table-id $R || true
        done

        # Delete internet gateway
        IGW=$(aws ec2 describe-internet-gateways \
          --filters "Name=attachment.vpc-id,Values=$VPC_ID" \
          --query "InternetGateways[0].InternetGatewayId" --output text)

        if [ "$IGW" != "None" ]; then
          echo "Deleting IGW: $IGW"
          aws ec2 detach-internet-gateway --internet-gateway-id $IGW --vpc-id $VPC_ID || true
          aws ec2 delete-internet-gateway --internet-gateway-id $IGW || true
        fi

        # Delete security groups
        SGS=$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=$VPC_ID" \
          --query "SecurityGroups[*].GroupId" --output text)

        for SG in $SGS; do
          if [[ "$SG" != *"default"* ]]; then
            echo "Deleting SG: $SG"
            aws ec2 delete-security-group --group-id $SG || true
          fi
        done

        # Delete VPC
        echo "Deleting VPC: $VPC_ID"
        aws ec2 delete-vpc --vpc-id $VPC_ID || true

    #################################################################
    # FINAL: TERRAFORM DESTROY (clean state only)
    #################################################################
    - name: Terraform Destroy
      working-directory: ./infra
      run: |
        terraform destroy -auto-approve \
          -var-file="env/${{ github.event.inputs.env }}.tfvars" \
          -var="api_image=placeholder" \
          -var="product_image=placeholder" \
          -var="inventory_image=placeholder" \
          -var="postgres_image=placeholder"

    - name: Purge finished
      run: echo "Environment ${{ github.event.inputs.env }} purged successfully."
