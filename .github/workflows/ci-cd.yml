name: StockWiz CI/CD Pipeline - DEV y TEST

on:
  push:
    branches: ["develop"]

permissions:
  contents: read
  id-token: write

jobs:
  # =======================================================
  # JOB 1: VALIDACI√ìN y DESPLIEGUE a DEV
  # =======================================================
  deploy_dev:
    runs-on: ubuntu-latest
    
    # üí° CR√çTICO: Exponer la URL del registro ECR como Output del Job
    outputs:
      ecr_registry_url: ${{ steps.ecr_dev.outputs.registry }}
      dev_alb_url: ${{ steps.get_dev_url.outputs.dev_alb_url }}

    steps:
      # ‚û°Ô∏è CHECKOUT
      - name: Checkout Code
        uses: actions/checkout@v4

      # ‚û°Ô∏è AWS CREDENTIALS
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      # ‚û°Ô∏è TERRAFORM INIT & SETUP
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init - DEV
        working-directory: ./infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=stockwiz-tfstate" \
            -backend-config="key=dev/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"
            
      # ‚û°Ô∏è QUALITY GATE: AN√ÅLISIS EST√ÅTICO CON FLAKE8
      - name: Ejecutar Flake8 y Generar Reporte
        id: flake8_check
        working-directory: ./product-service
        run: |
          pip install -r requirements.txt
          pip install flake8
          # Usar || true para no detener el workflow
          flake8 main.py > flake8_report.txt 2>&1 || true
          cat flake8_report.txt

      # ‚û°Ô∏è TERRAFORM APPLY #1 ‚Äî CREAR ECR + VPC + ALB + ECS vac√≠o
      - name: Terraform apply - DEV (Infra Base)
        working-directory: ./infra
        # Nota: El segundo apply con la imagen se encarga de este apply tambi√©n si no hay cambios.
        run: "terraform apply -auto-approve -var-file=\"env/dev.tfvars\" -var=\"db_password_secret=${{ secrets.DB_PASSWORD_DEV }}\" -var=\"inventory_api_key_secret=${{ secrets.INVENTORY_KEY_DEV }}\""
        
      # ‚û°Ô∏è LOGIN ECR
      - name: Login ECR
        id: ecr_dev
        uses: aws-actions/amazon-ecr-login@v2
        
      # ‚û°Ô∏è BUILD & PUSH FULLSTACK IMAGE
      - name: Build & push fullstack container
        run: |
          REG="${{ steps.ecr_dev.outputs.registry }}"
          docker build -t $REG/stockwiz-dev/fullstack:dev-latest .
          docker push $REG/stockwiz-dev/fullstack:dev-latest
          
      # ‚û°Ô∏è TERRAFORM APPLY #2 ‚Äî CREAR TASK DEFINITION CON LA IMAGEN
      - name: Terraform apply - DEV (Imagen Final)
        id: apply_dev_image
        working-directory: ./infra
        run: "terraform apply -auto-approve -var-file=\"env/dev.tfvars\" -var=\"full_image=${{ steps.ecr_dev.outputs.registry }}/stockwiz-dev/fullstack:dev-latest\" -var=\"db_password_secret=${{ secrets.DB_PASSWORD_DEV }}\" -var=\"inventory_api_key_secret=${{ secrets.INVENTORY_KEY_DEV }}\""
        
      # ‚û°Ô∏è UPDATE ECS SERVICE
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster stockwiz-dev-cluster \
            --service stockwiz-dev-svc \
            --force-new-deployment

      # ‚û°Ô∏è OBTENER EL DNS DEL ALB PARA EL JOB SIGUIENTE
      - name: Get ALB DNS Name - DEV
        id: get_dev_url
        working-directory: ./infra
        run: echo "dev_alb_url=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT


  # ----------------------------------------------------
  # JOB 2: DESPLIEGUE a TEST y PRUEBAS FUNCIONALES
  # ----------------------------------------------------
  test_functional:
    name: Run Functional Tests (TEST Env)
    runs-on: ubuntu-latest
    needs: deploy_dev # Depende del √©xito del despliegue en DEV
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # ‚û°Ô∏è 1. Configuraci√≥n AWS y Terraform (Mismo setup que DEV)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # ‚û°Ô∏è 2. Despliegue de Infraestructura TEST
      - name: Terraform init - TEST
        working-directory: ./infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=stockwiz-tfstate" \
            -backend-config="key=test/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"

      - name: Terraform apply - TEST (Despliegue Temporal)
        id: deploy_test
        working-directory: ./infra
        run: |
          ABS_TFVARS_PATH="${GITHUB_WORKSPACE}/infra/env/test.tfvars"
          
          # CR√çTICO: Usar el output directo del Job deploy_dev para la imagen
          terraform apply -auto-approve -var-file="$ABS_TFVARS_PATH" \
            -var="full_image=${{ needs.deploy_dev.outputs.ecr_registry_url }}/stockwiz-dev/fullstack:dev-latest" \
            -var="db_password_secret=${{ secrets.DB_PASSWORD_TEST }}" \
            -var="inventory_api_key_secret=${{ secrets.INVENTORY_KEY_TEST }}"
            
      # ‚û°Ô∏è 3. Obtener la URL del ALB de TEST
      - name: Get ALB DNS Name - TEST
        id: get_test_url
        working-directory: ./infra
        run: |
          # üí° Asignar el DNS del ALB directamente a la variable de entorno global
          TEST_ALB_URL=$(terraform output -raw alb_dns_name)
          echo "TEST_BASE_URL=$TEST_ALB_URL" >> $GITHUB_ENV # Usaremos ${{ env.TEST_BASE_URL }}
        
      # ‚û°Ô∏è 4. Ejecuci√≥n de Pruebas Funcionales (Newman)
      - name: Ejecutar Pruebas Funcionales (Newman)
        working-directory: ./tests
        run: |
          echo "Iniciando pruebas Newman..."
          
          # Instalar globalmente para asegurar disponibilidad
          npm install -g newman
          npm install -g newman-reporter-junitfull

          echo "Esperando 30 segundos para la propagaci√≥n del ALB..."
          sleep 30 # CR√çTICO: Esperar al ALB
          
          echo "DEBUG: TEST_BASE_URL is ${{ env.TEST_BASE_URL }}"
          
          # Ejecutar Newman usando --global-var
          newman run stockwiz_api_collection.json \
            --global-var "BASE_URL=${{ env.TEST_BASE_URL }}" \
            --reporters cli,junitfull \
            --reporter-junit-export results/newman_report.xml
            
          # CR√çTICO: Forzar la falla del Job si Newman falla (c√≥digo de salida != 0)
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: Las pruebas funcionales fallaron."
            exit 1
          fi

      - name: Subir Reporte Newman como Artifact
        if: always() # Subir el reporte aunque falle
        uses: actions/upload-artifact@v4
        with:
          name: reporte-pruebas-funcionales-${{ github.sha }}
          path: tests/results/newman_report.xml
          
      # ‚û°Ô∏è 5. Cleanup (Destruir el ambiente de TEST)
      #- name: Destruir Infraestructura TEST
      #  if: always() # Ejecutar siempre, incluso si las pruebas fallaron
      #  working-directory: ./infra
      #  run: |
      #    echo "Destruyendo ambiente TEST despu√©s de la ejecuci√≥n de pruebas..."
          # CR√çTICO: Pasar las mismas variables para que Terraform encuentre el estado
      #    terraform destroy -var-file="env/test.tfvars" -auto-approve \
      #      -var="full_image=${{ needs.deploy_dev.outputs.ecr_registry_url }}/stockwiz-dev/fullstack:dev-latest" \
      #      -var="db_password_secret=${{ secrets.DB_PASSWORD_TEST }}" \
      #      -var="inventory_api_key_secret=${{ secrets.INVENTORY_KEY_TEST }}"
