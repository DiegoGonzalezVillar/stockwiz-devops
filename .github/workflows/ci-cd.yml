name: StockWiz CI/CD Pipeline - DEV , TEST Y PROD
on:
  push:
    branches: ["develop"]

permissions:
  contents: read
  id-token: write

jobs:

  deploy_dev:
    runs-on: ubuntu-latest
    
    outputs:
      ecr_registry_url: ${{ steps.ecr_dev.outputs.registry }}
      dev_alb_url: ${{ steps.get_dev_url.outputs.dev_alb_url }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init - DEV
        working-directory: ./infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=stockwiz-tfstate" \
            -backend-config="key=dev/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"
            
      - name: Ejecutar Flake8 y Generar Reporte
        id: flake8_check
        working-directory: ./product-service
        run: |
          pip install -r requirements.txt
          pip install flake8
          # Usar || true para no detener el workflow
          flake8 main.py > flake8_report.txt 2>&1 || true
          cat flake8_report.txt

      - name: Terraform apply - DEV (Infra Base)
        working-directory: ./infra

        run: "terraform apply -auto-approve -var-file=\"env/dev.tfvars\" -var=\"db_password_secret=${{ secrets.DB_PASSWORD_DEV }}\" -var=\"inventory_api_key_secret=${{ secrets.INVENTORY_KEY_DEV }}\""
        
      - name: Login ECR
        id: ecr_dev
        uses: aws-actions/amazon-ecr-login@v2
        
      - name: Build & push fullstack container
        run: |
          REG="${{ steps.ecr_dev.outputs.registry }}"
          docker build -t $REG/stockwiz-dev/fullstack:dev-latest .
          docker push $REG/stockwiz-dev/fullstack:dev-latest
          
      - name: Terraform apply - DEV (Imagen Final)
        id: apply_dev_image
        working-directory: ./infra
        run: "terraform apply -auto-approve -var-file=\"env/dev.tfvars\" -var=\"full_image=${{ steps.ecr_dev.outputs.registry }}/stockwiz-dev/fullstack:dev-latest\" -var=\"db_password_secret=${{ secrets.DB_PASSWORD_DEV }}\" -var=\"inventory_api_key_secret=${{ secrets.INVENTORY_KEY_DEV }}\""
        
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster stockwiz-dev-cluster \
            --service stockwiz-dev-svc \
            --force-new-deployment

      - name: Get ALB DNS Name - DEV
        id: get_dev_url
        working-directory: ./infra
        run: echo "dev_alb_url=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT


  #TEST
  test_functional:
    name: Run Functional Tests (TEST Env)
    runs-on: ubuntu-latest
    needs: deploy_dev 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init - TEST
        working-directory: ./infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=stockwiz-tfstate" \
            -backend-config="key=test/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"

      - name: Terraform apply - TEST (Despliegue Temporal)
        id: deploy_test
        working-directory: ./infra
        run: |
          ABS_TFVARS_PATH="${GITHUB_WORKSPACE}/infra/env/test.tfvars"
          
          # CR√çTICO: Usar el output directo del Job deploy_dev para la imagen
          terraform apply -auto-approve -var-file="$ABS_TFVARS_PATH" \
            -var="full_image=${{ needs.deploy_dev.outputs.ecr_registry_url }}/stockwiz-dev/fullstack:dev-latest" \
            -var="db_password_secret=${{ secrets.DB_PASSWORD_TEST }}" \
            -var="inventory_api_key_secret=${{ secrets.INVENTORY_KEY_TEST }}"
            
      - name: Get ALB DNS Name - TEST
        id: get_test_url
        working-directory: ./infra
        run: |
          # üí° Asignar el DNS del ALB directamente a la variable de entorno global
          TEST_ALB_URL=$(terraform output -raw alb_dns_name)
          echo "TEST_BASE_URL=$TEST_ALB_URL" >> $GITHUB_ENV # Usaremos ${{ env.TEST_BASE_URL }}
        
      - name: Ejecutar Pruebas Funcionales (Newman)
        working-directory: ./tests
        run: |
          echo "Iniciando pruebas Newman..."
          
          # Instalar globalmente para asegurar disponibilidad
          npm install -g newman
          npm install -g newman-reporter-junitfull

          echo "Esperando 30 segundos para la propagaci√≥n del ALB..."
          sleep 120 # CR√çTICO: Esperar al ALB
          
          echo "DEBUG: TEST_BASE_URL is ${{ env.TEST_BASE_URL }}"
          
          # Ejecutar Newman usando --global-var
          newman run stockwiz_api_collection.json \
            --global-var "BASE_URL=${{ env.TEST_BASE_URL }}" \
            --reporters cli,junitfull \
            --reporter-junit-export newman_report.xml
            
          # CR√çTICO: Forzar la falla del Job si Newman falla (c√≥digo de salida != 0)
          if [ $? -ne 0 ]; then
            echo "ERROR: Las pruebas funcionales fallaron."
            exit 1
          fi

      - name: Subir Reporte Newman como Artifact
        if: always() # Subir el reporte aunque falle
        uses: actions/upload-artifact@v4
        with:
          name: reporte-pruebas-funcionales-${{ github.sha }}
          path: tests/results/newman_report.xml
          
      - name: Destruir Infraestructura TEST
        if: always() # Ejecutar siempre, incluso si las pruebas fallaron
        working-directory: ./infra
        run: |
          echo "Destruyendo ambiente TEST despu√©s de la ejecuci√≥n de pruebas..."

          terraform destroy -var-file="env/test.tfvars" -auto-approve \
            -var="full_image=${{ needs.deploy_dev.outputs.ecr_registry_url }}/stockwiz-dev/fullstack:dev-latest" \
            -var="db_password_secret=${{ secrets.DB_PASSWORD_TEST }}" \
            -var="inventory_api_key_secret=${{ secrets.INVENTORY_KEY_TEST }}"
# PRODUCCI√ìN
  deploy_prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test_functional
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}
  
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
  
      - name: Terraform init - PROD
        working-directory: ./infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=stockwiz-tfstate" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"
  
      - name: Terraform apply - PROD (Despliegue Final)
        working-directory: ./infra
        run: |
          ABS_TFVARS_PATH="${GITHUB_WORKSPACE}/infra/env/prod.tfvars"
          
          # CR√çTICO: Usar la imagen creada en el Job deploy_dev (si tu proceso de building es all√≠)
          terraform apply -auto-approve -var-file="$ABS_TFVARS_PATH" \
            -var="full_image=${{ needs.deploy_dev.outputs.ecr_registry_url }}/stockwiz-dev/fullstack:dev-latest" \
            -var="db_password_secret=${{ secrets.DB_PASSWORD_PROD }}" \
            -var="inventory_api_key_secret=${{ secrets.INVENTORY_KEY_PROD }}"
